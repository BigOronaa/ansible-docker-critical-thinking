---
- name: Monitor Docker containers and collect logs
  hosts: all
  become: true

  tasks:
    # 1️⃣ Get all container names from Docker
    - name: Get list of Docker containers
      command: docker ps -a --format "{{ '{{' }}.Names{{ '}}' }}"
      register: docker_containers
      changed_when: false

    # 2️⃣ Fail if no containers exist
    - name: Fail if no Docker containers are found
      fail:
        msg: "No Docker containers found on this host"
      when: docker_containers.stdout_lines | length == 0

    # 3️⃣ Inspect each container
    - name: Inspect Docker containers
      community.docker.docker_container_info:
        name: "{{ item }}"
      loop: "{{ docker_containers.stdout_lines }}"
      register: container_status

    # 4️⃣ Show container status
    - name: Show container status
      debug:
        msg: >
          Container {{ item.item }} status:
          {{ item.container.State.Status }}
      loop: "{{ container_status.results }}"

    # 5️⃣ Fail if any container is not running
    - name: Fail if container is not running
      fail:
        msg: "Container {{ item.item }} is not running"
      when: item.container.State.Status != "running"
      loop: "{{ container_status.results }}"

    # 6️⃣ Fetch container logs
    - name: Fetch container logs
      command: docker logs --tail 50 {{ item }}
      loop: "{{ docker_containers.stdout_lines }}"
      register: container_logs
      ignore_errors: true

    # 7️⃣ Print container logs
    - name: Print container logs
      debug:
        var: container_logs.results
