---
- name: Monitor Docker containers and collect logs
  hosts: all
  become: true

  tasks:
    - name: Get running containers
      community.docker.docker_container_info:
        name: "{{ item }}"
      loop:
        - nginx
        - mysql
        - redis
      register: container_status
      ignore_errors: true

    - name: Show container status
      debug:
        msg: >
          Container {{ item.item }} running:
          {{ item.container.State.Status | default('NOT FOUND') }}
      loop: "{{ container_status.results }}"

    - name: Fail if any container is not running
      fail:
        msg: "Container {{ item.item }} is not running"
      when: item.container.State.Status != "running"
      loop: "{{ container_status.results }}"

    - name: Fetch container logs
      command: docker logs --tail 50 {{ item }}
      loop:
        - nginx
        - mysql
        - redis
      register: container_logs
      ignore_errors: true

    - name: Print container logs
      debug:
        var: container_logs.results
