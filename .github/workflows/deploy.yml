name: Deploy Docker Containers

on:
  push:
    branches:
      - master

jobs:
  ansible-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Set up Python 3.10 for Ansible compatibility
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # Upgrade pip and install Ansible 2.19.5 + community docker collection
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible==2.19.5
          pip install "ansible[community.docker]"

      # Add SSH key for connecting to EC2 instances
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # Run playbook for Development environment
      - name: Run Ansible Playbook - Development
        run: ansible-playbook -i inventories/dev.ini playbooks/site.yml

      # Run playbook for Staging environment
      - name: Run Ansible Playbook - Staging
        run: ansible-playbook -i inventories/staging.ini playbooks/site.yml

      # Run playbook for Production environment
      - name: Run Ansible Playbook - Production
        run: ansible-playbook -i inventories/production.ini playbooks/site.yml
